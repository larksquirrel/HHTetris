<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿„ç½—æ–¯æ–¹å— - é»‘ç²‰è‰²ç³»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f0b1e 0%, #1a0f2e 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 5px;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            margin: 5px 0 8px;
            width: 100%;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 3px;
            background: linear-gradient(to right, #ff2a8f, #ff7eb3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(255, 42, 143, 0.3);
        }

        .subtitle {
            color: #ff9ec9;
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 100%;
        }

        .main-game {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 10px;
        }

        .game-board-container {
            position: relative;
            background: linear-gradient(145deg, rgba(20, 10, 30, 0.9), rgba(30, 15, 40, 0.9));
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 10px rgba(255, 42, 143, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 122, 179, 0.2);
            width: 100%;
            max-width: 300px;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(20, 1fr);
            width: 100%;
            height: 50vh;
            max-height: 400px;
            background-color: rgba(10, 5, 20, 0.9);
            border: 2px solid rgba(255, 122, 179, 0.3);
            border-radius: 4px;
            overflow: hidden;
            transition: background-color 0.5s, filter 0.5s;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* å¤œå¹•é™ä¸´æ•ˆæœ - å…¨é»‘ */
        .night-fall {
            background-color: #000 !important;
            filter: brightness(0.1);
        }

        /* å†¤é­‚æ•ˆæœ - é»‘è‰²æ–¹å— */
        .yuan-ghost .cell.filled.i,
        .yuan-ghost .cell.filled.j,
        .yuan-ghost .cell.filled.l,
        .yuan-ghost .cell.filled.o,
        .yuan-ghost .cell.filled.s,
        .yuan-ghost .cell.filled.t,
        .yuan-ghost .cell.filled.z {
            background-color: #000000 !important;
            border-color: #444444 !important;
        }

        /* æµè¡€å¤©æ°”æ•ˆæœ - çº¢è‰²æ–¹å— */
        .blood-weather .cell.filled.i,
        .blood-weather .cell.filled.j,
        .blood-weather .cell.filled.l,
        .blood-weather .cell.filled.o,
        .blood-weather .cell.filled.s,
        .blood-weather .cell.filled.t,
        .blood-weather .cell.filled.z {
            background-color: #ff2a2a !important;
            border-color: #ff7a7a !important;
        }

        /* å½“å†¤é­‚å’Œæµè¡€å¤©æ°”åŒæ—¶å­˜åœ¨æ—¶ï¼Œä¼˜å…ˆæ˜¾ç¤ºå†¤é­‚ï¼ˆé»‘è‰²ï¼‰ */
        .yuan-ghost.blood-weather .cell.filled.i,
        .yuan-ghost.blood-weather .cell.filled.j,
        .yuan-ghost.blood-weather .cell.filled.l,
        .yuan-ghost.blood-weather .cell.filled.o,
        .yuan-ghost.blood-weather .cell.filled.s,
        .yuan-ghost.blood-weather .cell.filled.t,
        .yuan-ghost.blood-weather .cell.filled.z {
            background-color: #000000 !important;
            border-color: #444444 !important;
        }

        .info-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }

        .top-info {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .score-panel {
            background: linear-gradient(145deg, rgba(20, 10, 30, 0.9), rgba(30, 15, 40, 0.9));
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(255, 42, 143, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 122, 179, 0.2);
            flex: 1;
        }

        .next-piece-panel {
            background: linear-gradient(145deg, rgba(20, 10, 30, 0.9), rgba(30, 15, 40, 0.9));
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(255, 42, 143, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 122, 179, 0.2);
            width: 120px;
        }

        .info-title {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #ff7eb3;
            text-align: center;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .score-display {
            font-size: 1.8rem;
            text-align: center;
            font-weight: bold;
            color: #ff4d9e;
            margin: 5px 0;
            text-shadow: 0 2px 8px rgba(255, 77, 158, 0.5);
        }

        .next-piece-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .next-piece-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            width: 80px;
            height: 80px;
            background-color: rgba(10, 5, 20, 0.9);
            border-radius: 4px;
            margin-top: 5px;
            border: 1px solid rgba(255, 122, 179, 0.3);
        }

        .items-panel {
            background: linear-gradient(145deg, rgba(20, 10, 30, 0.9), rgba(30, 15, 40, 0.9));
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(255, 42, 143, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 122, 179, 0.2);
            width: 100%;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            background: linear-gradient(145deg, rgba(30, 15, 40, 0.9), rgba(20, 10, 30, 0.9));
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            height: 100%;
            justify-content: space-between;
            border: 2px solid;
        }

            .item:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            }

            .item:active {
                transform: translateY(0);
            }

            .item.disabled {
                opacity: 0.5;
                filter: grayscale(0.7);
                cursor: not-allowed;
                pointer-events: none;
            }

        .item-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            z-index: 2;
        }

        .item-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .item-count {
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            color: #ff7eb3;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .item-recovery {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            z-index: 1;
            transition: width 0.1s linear;
            border-radius: 0 0 4px 4px;
        }

        /* é“å…·é¢œè‰²è°ƒæ•´ - æŒ‰ç…§æ–°é¡ºåº */
        .item.mojing {
            border-color: #000000;
        }

        .item.haitang {
            border-color: #ff4081;
        }

        .item.sodawater {
            border-color: #2196f3;
        }

        .item.qingjunce {
            border-color: #ffc107;
        }

        /* é“å…·æ¢å¤è¿›åº¦æ¡é¢œè‰² */
        .item.mojing .item-recovery {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.5));
        }

        .item.haitang .item-recovery {
            background: linear-gradient(90deg, rgba(255, 64, 129, 0.3), rgba(255, 64, 129, 0.5));
        }

        .item.sodawater .item-recovery {
            background: linear-gradient(90deg, rgba(33, 150, 243, 0.3), rgba(33, 150, 243, 0.5));
        }

        .item.qingjunce .item-recovery {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.3), rgba(255, 193, 7, 0.5));
        }

        .controls-container {
            margin-top: 15px;
            width: 100%;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .buttons-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 5px;
        }

        .game-button {
            background: linear-gradient(to bottom, #ff2a8f, #ff4d9e);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 42, 143, 0.3);
            flex: 1;
            max-width: 140px;
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }

            .game-button::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }

            .game-button:hover::after {
                left: 100%;
            }

            .game-button:hover, .game-button:active {
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(255, 42, 143, 0.4);
            }

            .game-button:active {
                transform: translateY(1px);
            }

            .game-button.pause {
                background: linear-gradient(to bottom, #ff7eb3, #ff9ec9);
            }

        .touch-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            height: 150px;
            width: 100%;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .touch-btn {
            background: linear-gradient(145deg, rgba(40, 20, 50, 0.9), rgba(30, 15, 40, 0.9));
            border: 2px solid rgba(255, 122, 179, 0.4);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            color: #ff7eb3;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }

            .touch-btn:active {
                background: linear-gradient(145deg, rgba(50, 25, 60, 0.9), rgba(40, 20, 50, 0.9));
                transform: scale(0.95);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .touch-btn.rotate {
                grid-column: 2;
                grid-row: 1;
            }

            .touch-btn.left {
                grid-column: 1;
                grid-row: 2;
            }

            .touch-btn.down {
                grid-column: 2;
                grid-row: 2;
            }

            .touch-btn.right {
                grid-column: 3;
                grid-row: 2;
            }

            .touch-btn.drop {
                grid-column: 2;
                grid-row: 3;
            }

        .cell {
            width: 100%;
            height: 100%;
            border: 1px solid rgba(255, 122, 179, 0.1);
            transition: background-color 0.3s, transform 0.2s;
        }

        .filled {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* æ–¹å—é¢œè‰² - ç»å…¸ä¿„ç½—æ–¯æ–¹å—é¢œè‰²ï¼ˆä¿æŒåŸæ ·ï¼‰ */
        .i {
            background-color: #00bcd4;
        }
        /* Iå‹ - é’è‰² */
        .j {
            background-color: #2196f3;
        }
        /* Jå‹ - è“è‰² */
        .l {
            background-color: #ff9800;
        }
        /* Lå‹ - æ©™è‰² */
        .o {
            background-color: #ffeb3b;
        }
        /* Oå‹ - é»„è‰² */
        .s {
            background-color: #4caf50;
        }
        /* Så‹ - ç»¿è‰² */
        .t {
            background-color: #9c27b0;
        }
        /* Tå‹ - ç´«è‰² */
        .z {
            background-color: #f44336;
        }
        /* Zå‹ - çº¢è‰² */

        .game-status {
            text-align: center;
            margin-top: 8px;
            font-size: 1rem;
            font-weight: bold;
            height: 24px;
            color: #ff7eb3;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* äº‹ä»¶å¼¹çª—æ ·å¼ */
        .event-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 8, 25, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

            .event-modal.active {
                opacity: 1;
                visibility: visible;
            }

        .event-content {
            background: linear-gradient(145deg, rgba(25, 12, 35, 0.95), rgba(35, 17, 45, 0.95));
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(255, 42, 143, 0.2);
            border: 2px solid rgba(255, 122, 179, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }

        .event-modal.active .event-content {
            transform: translateY(0);
        }

        .event-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #ff7eb3;
            text-shadow: 0 2px 10px rgba(255, 126, 179, 0.5);
        }

        .event-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

            .event-type.item {
                background: linear-gradient(to right, #ff4d9e, #ff2a8f);
                color: white;
                box-shadow: 0 2px 6px rgba(255, 77, 158, 0.3);
            }

            .event-type.story {
                background: linear-gradient(to right, #ff7eb3, #ff4d9e);
                color: white;
                box-shadow: 0 2px 6px rgba(255, 126, 179, 0.3);
            }

        .event-description {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 15px;
            color: #ff9ec9;
        }

        .event-effect {
            background: rgba(255, 122, 179, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid #ff7eb3;
        }

        .event-effect-title {
            font-weight: bold;
            color: #ff7eb3;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .event-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .event-button {
            background: linear-gradient(to bottom, #ff2a8f, #ff4d9e);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 42, 143, 0.3);
        }

            .event-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 12px rgba(255, 42, 143, 0.4);
            }

            .event-button.consume {
                background: linear-gradient(to bottom, #ff4d9e, #ff2a8f);
            }

            .event-button.cancel {
                background: linear-gradient(to bottom, #666666, #444444);
            }

        .yuan-character {
            font-size: 5rem;
            color: #000000;
            text-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'SimHei', 'Microsoft YaHei', sans-serif;
            margin: 15px 0;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }

        .confirm-button {
            background: linear-gradient(to bottom, #ff2a8f, #ff4d9e);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 42, 143, 0.3);
        }

            .confirm-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(255, 42, 143, 0.4);
            }

        .input-container {
            margin: 15px 0;
        }

        .input-text {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #ff9ec9;
        }

        .text-input {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 2px solid #ff2a8f;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

            .text-input:focus {
                outline: none;
                border-color: #ff7eb3;
                box-shadow: 0 0 12px rgba(255, 126, 179, 0.5);
                background-color: rgba(255, 255, 255, 0.15);
            }

        .instructions {
            margin-top: 15px;
            max-width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: #ff9ec9;
            line-height: 1.4;
            padding: 0 10px;
        }

        .control-instructions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            background: rgba(255, 122, 179, 0.1);
            padding: 10px;
            border-radius: 8px;
            max-width: 100%;
            border: 1px solid rgba(255, 122, 179, 0.2);
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #ff9ec9;
        }

        .control-icon {
            background: rgba(255, 122, 179, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 35px;
            text-align: center;
            color: #ff7eb3;
        }

        .footer {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #ff9ec9;
            font-size: 0.7rem;
            text-align: center;
            opacity: 0.7;
        }

        .freeze-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(139, 69, 19, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 4px;
            pointer-events: none;
        }

        .freeze-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            animation: pulse 1s infinite;
            background-color: rgba(139, 69, 19, 0.7);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .night-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            z-index: 101;
            text-align: center;
            width: 100%;
        }

        .item-added {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(to right, #ff4d9e, #ff2a8f);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 999;
            animation: slideIn 0.5s, fadeOut 0.5s 2s forwards;
            box-shadow: 0 4px 12px rgba(255, 77, 158, 0.4);
            font-size: 0.9rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
            }
        }

        .brass-box-special {
            position: relative;
            border: 2px solid #ffd700 !important;
            background: linear-gradient(145deg, rgba(50, 35, 10, 0.9), rgba(70, 50, 20, 0.9)) !important;
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
            }

            to {
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            }
        }

        /* æ¨ªå‘æ‰‹æœºé€‚é… */
        @media (max-height: 600px) and (orientation: landscape) {
            .main-game {
                flex-direction: row;
                justify-content: space-around;
                align-items: flex-start;
            }

            .game-board-container {
                max-width: 200px;
                height: 70vh;
            }

            .game-board {
                height: 60vh;
            }

            .info-container {
                max-width: 200px;
                height: 70vh;
                overflow-y: auto;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }
        }

        /* è¶…å°å±å¹•é€‚é… */
        @media (max-width: 320px) {
            .game-board-container {
                padding: 6px;
            }

            .game-board {
                height: 45vh;
            }

            .score-display {
                font-size: 1.6rem;
            }

            .next-piece-board {
                width: 70px;
                height: 70px;
            }

            .game-button {
                padding: 10px 16px;
                font-size: 0.9rem;
                max-width: 130px;
                min-width: 110px;
            }

            .touch-controls {
                height: 130px;
                max-width: 250px;
            }

            .touch-btn {
                font-size: 1.4rem;
            }

            .item {
                padding: 6px;
            }

            .item-name {
                font-size: 0.8rem;
            }

            .item-count {
                font-size: 1.2rem;
            }
        }

        /* ä¸­ç­‰å±å¹•é€‚é… */
        @media (min-width: 768px) {
            .game-board-container {
                max-width: 350px;
            }

            .game-board {
                height: 500px;
            }

            .info-container {
                max-width: 350px;
            }

            .next-piece-board {
                width: 100px;
                height: 100px;
            }

            .game-button {
                max-width: 160px;
                min-width: 140px;
            }

            .touch-controls {
                height: 180px;
                max-width: 320px;
            }

            .touch-btn {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ä¿„ç½—æ–¯æ–¹å— - é»‘ç²‰è‰²ç³»</h1>
        <div class="subtitle">ç‚¹å‡»é“å…·ç›´æ¥ä½¿ç”¨ | é»‘ç²‰é…è‰² | æ‰‹æœºä¼˜åŒ–</div>
    </div>

    <div class="game-container">
        <div class="main-game">
            <div class="game-board-container">
                <div class="game-board" id="game-board"></div>
                <div class="game-status" id="game-status">å‡†å¤‡å¼€å§‹</div>
            </div>

            <div class="info-container">
                <div class="top-info">
                    <div class="score-panel">
                        <div class="info-title">åˆ†æ•°</div>
                        <div class="score-display" id="score">0</div>
                    </div>

                    <div class="next-piece-panel">
                        <div class="info-title">ä¸‹ä¸€ä¸ª</div>
                        <div class="next-piece-container">
                            <div class="next-piece-board" id="next-piece-board"></div>
                        </div>
                    </div>
                </div>

                <div class="items-panel">
                    <div class="info-title">é“å…·æ  (ç‚¹å‡»ä½¿ç”¨)</div>
                    <div class="items-grid">
                        <!-- æ–°é¡ºåºï¼šå¢¨é•œ â†’ æµ·æ£  â†’ è‹æ‰“æ°´ â†’ æ¸…å›ä¾§ -->
                        <div class="item mojing" id="mojing-item">
                            <div class="item-header">
                                <span class="item-name">å¢¨é•œ</span>
                                <span class="item-count" id="mojing-count">0</span>
                            </div>
                            <div class="item-recovery" id="mojing-recovery"></div>
                        </div>

                        <div class="item haitang" id="haitang-item">
                            <div class="item-header">
                                <span class="item-name">æµ·æ£ </span>
                                <span class="item-count" id="haitang-count">0</span>
                            </div>
                            <div class="item-recovery" id="haitang-recovery"></div>
                        </div>

                        <div class="item sodawater" id="sodawater-item">
                            <div class="item-header">
                                <span class="item-name">è‹æ‰“æ°´</span>
                                <span class="item-count" id="sodawater-count">0</span>
                            </div>
                            <div class="item-recovery" id="sodawater-recovery"></div>
                        </div>

                        <div class="item qingjunce" id="qingjunce-item">
                            <div class="item-header">
                                <span class="item-name">æ¸…å›ä¾§</span>
                                <span class="item-count" id="qingjunce-count">0</span>
                            </div>
                            <div class="item-recovery" id="qingjunce-recovery"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-container">
            <div class="buttons-row">
                <button class="game-button" id="start-restart-button">å¼€å§‹æ¸¸æˆ</button>
                <button class="game-button pause" id="pause-resume-button" disabled>æš‚åœ</button>
            </div>

            <div class="touch-controls">
                <div class="touch-btn rotate" id="rotate-btn">â†»</div>
                <div class="touch-btn left" id="left-btn">â†</div>
                <div class="touch-btn down" id="down-btn">â†“</div>
                <div class="touch-btn right" id="right-btn">â†’</div>
                <div class="touch-btn drop" id="drop-btn">â†“</div>
            </div>

            <div class="control-instructions">
                <div class="control-item">
                    <span class="control-icon">âœ¨</span>
                    <span>ç‚¹å‡»é“å…·ç›´æ¥ä½¿ç”¨ï¼è¿›åº¦æ¡æ»¡å³å¯ç”¨</span>
                </div>
                <div class="control-item">
                    <span class="control-icon">ğŸ“±</span>
                    <span>ä¸“ä¸ºæ‰‹æœºå±å¹•ä¼˜åŒ–</span>
                </div>
            </div>
        </div>

        <div class="instructions">
            æ¸¸æˆç›®æ ‡ï¼šç§»åŠ¨ã€æ—‹è½¬å’Œæ”¾ç½®ä¸‹è½çš„æ–¹å—ï¼Œå½¢æˆå®Œæ•´çš„æ°´å¹³è¡Œæ¥å¾—åˆ†ã€‚æ¯æ¬¡æ¶ˆé™¤éƒ½ä¼šè§¦å‘éšæœºå‰§æƒ…ï¼Œç‚¹å‡»é“å…·å¯ç›´æ¥ä½¿ç”¨ï¼
        </div>
    </div>

    <div class="footer">
        ä¿„ç½—æ–¯æ–¹å— Â© 2023 | é»‘ç²‰è‰²ç³» | ç‚¹å‡»é“å…·ä½¿ç”¨
    </div>

    <!-- äº‹ä»¶å¼¹çª— -->
    <div class="event-modal" id="event-modal">
        <div class="event-content">
            <h2 class="event-title" id="event-title">å‰§æƒ…è§¦å‘</h2>
            <div class="event-type story" id="event-type">å‰§æƒ…</div>
            <div class="event-description" id="event-description">
                æ‚¨è§¦å‘äº†ä¸€ä¸ªéšæœºå‰§æƒ…ï¼
            </div>
            <div class="event-effect">
                <div class="event-effect-title">å‰§æƒ…æ•ˆæœ</div>
                <div id="event-effect-desc"></div>
            </div>
            <div id="event-actions"></div>
        </div>
    </div>

    <!-- é“å…·é€‰æ‹©å¼¹çª— -->
    <div class="event-modal" id="item-select-modal">
        <div class="event-content">
            <h2 class="event-title">é€‰æ‹©é“å…·</h2>
            <div class="event-description">
                è¯·é€‰æ‹©è¦ä½¿ç”¨çš„é“å…·ï¼š
            </div>
            <div id="item-options" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                <!-- é“å…·é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="confirm-button" id="cancel-item-button">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆå¸¸é‡
        const BOARD_WIDTH = 10;
        const BOARD_HEIGHT = 20;
        const EMPTY_CELL = 'empty';

        // é“å…·æ¢å¤æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        const ITEM_RECOVERY_TIMES = {
            mojing: 5000,      // å¢¨é•œï¼š5ç§’
            haitang: 5000,     // æµ·æ£ ï¼š5ç§’
            sodawater: 10000,  // è‹æ‰“æ°´ï¼š10ç§’
            qingjunce: 20000   // æ¸…å›ä¾§ï¼š20ç§’
        };

        // æ–¹å—å½¢çŠ¶å®šä¹‰
        const TETROMINOES = {
            I: {
                shape: [
                    [0, 0, 0, 0],
                    [1, 1, 1, 1],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0]
                ],
                className: 'i'
            },
            J: {
                shape: [
                    [1, 0, 0],
                    [1, 1, 1],
                    [0, 0, 0]
                ],
                className: 'j'
            },
            L: {
                shape: [
                    [0, 0, 1],
                    [1, 1, 1],
                    [0, 0, 0]
                ],
                className: 'l'
            },
            O: {
                shape: [
                    [1, 1],
                    [1, 1]
                ],
                className: 'o'
            },
            S: {
                shape: [
                    [0, 1, 1],
                    [1, 1, 0],
                    [0, 0, 0]
                ],
                className: 's'
            },
            T: {
                shape: [
                    [0, 1, 0],
                    [1, 1, 1],
                    [0, 0, 0]
                ],
                className: 't'
            },
            Z: {
                shape: [
                    [1, 1, 0],
                    [0, 1, 1],
                    [0, 0, 0]
                ],
                className: 'z'
            }
        };

        // å‰§æƒ…å®šä¹‰ï¼ˆé»„é“œç®±å­åªå‡ºç°ä¸€æ¬¡ï¼‰
        const STORIES = {
            SHIJUNZHILU: {
                name: "é£Ÿå›ä¹‹ç¦„",
                type: "å‰§æƒ…",
                description: "äº«å—æœå»·çš„ä¿¸ç¦„ï¼Œä¾¿è¦æ‰¿æ‹…ç›¸åº”çš„è´£ä»»",
                effect: "éœ€è¦æ¶ˆè€—1ä¸ªã€æµ·æ£ ã€‘æ‰èƒ½ç»§ç»­æ¸¸æˆï¼Œå¦åˆ™æ‰€æœ‰æ–¹å—å˜é»‘å¹¶æ˜¾ç¤º'å†¤'å­—",
                effectFunc: handleShijunzhilu,
                canAppear: true
            },
            NIGHTFALL: {
                name: "å¤œå¹•é™ä¸´",
                type: "å‰§æƒ…",
                description: "é»‘æš—ç¬¼ç½©å¤§åœ°ï¼Œè§†çº¿å˜å¾—æ¨¡ç³Š...",
                effect: "éœ€è¦æ¶ˆè€—1ä¸ªã€å¢¨é•œã€‘æ‰èƒ½ç»§ç»­æ¸¸æˆï¼Œå¦åˆ™å±å¹•å˜é»‘5ç§’ï¼ˆæ¸¸æˆæ­£å¸¸è¿›è¡Œï¼‰",
                effectFunc: handleNightFall,
                canAppear: true
            },
            IMMORTAL: {
                name: "é•¿ç”Ÿè€…",
                type: "å‰§æƒ…",
                description: "ä¼ è¯´ä¸­çš„é•¿ç”Ÿè€…å‡ºç°ï¼Œæ—¶é—´ä»¿ä½›å˜æ…¢äº†",
                effect: "æ–¹å—ä¸‹è½é€Ÿåº¦å˜ä¸ºåŸæ¥çš„ä¸€åŠï¼ŒæŒç»­20ç§’",
                effectFunc: activateImmortal,
                canAppear: true
            },
            FRIED_LIVER: {
                name: "ç‚’è‚",
                type: "å‰§æƒ…",
                description: "é—»åˆ°ä¸€è‚¡å¥‡ç‰¹çš„ç‚’è‚é¦™å‘³ï¼ŒåŠ¨ä½œå˜å¾—è¿Ÿç¼“",
                effect: "æ¸¸æˆç»§ç»­åç©å®¶ä¸èƒ½æ“ä½œ3ç§’ï¼ˆæ¸¸æˆæ­£å¸¸è¿›è¡Œï¼‰",
                effectFunc: activateFriedLiver,
                canAppear: true
            },
            BLOODY_WEATHER: {
                name: "æµè¡€çš„å¤©æ°”",
                type: "å‰§æƒ…",
                description: "å¤©ç©ºä¸‹èµ·äº†çº¢è‰²çš„é›¨ï¼Œä¸€åˆ‡éƒ½æŸ“ä¸Šäº†è¡€è‰²",
                effect: "æ¥ä¸‹æ¥çš„5ä¸ªæ–¹å—å…¨éƒ¨å˜ä¸ºçº¢è‰²",
                effectFunc: activateBloodyWeather,
                canAppear: true
            },
            OPERA: {
                name: "æˆæ›²",
                type: "å‰§æƒ…",
                description: "è¿œå¤„ä¼ æ¥æ‚ æ‰¬çš„æˆæ›²å£°ï¼Œæ°›å›´å˜å¾—ä¸ä¸€æ ·äº†",
                effect: "æ¸¸æˆç»§ç»­ï¼Œå¿ƒæƒ…å˜å¾—æ„‰æ‚¦",
                effectFunc: activateOpera,
                canAppear: true
            },
            // æ–°å¢å‰§æƒ…
            SNOOPY: {
                name: "å²åŠªæ¯”",
                type: "å‰§æƒ…",
                description: "å¯çˆ±çš„å²åŠªæ¯”å‡ºç°ï¼Œå¸®ä½ æ’¤å›äº†ä¸€æ­¥",
                effect: "æ’¤å›è¿™ä¸€æ­¥æ–¹å—ï¼ˆä¸æ¶ˆé™¤ï¼‰",
                effectFunc: activateSnoopy,
                canAppear: true
            },
            BRASS_BOX: {
                name: "é»„é“œç®±å­",
                type: "å‰§æƒ…",
                description: "å‘ç°äº†ä¸€ä¸ªå¤è€çš„é»„é“œç®±å­ï¼Œé‡Œé¢è£…æ»¡äº†è´¢å®",
                effect: "åˆ†æ•°ç›´æ¥å˜æˆ9999",
                effectFunc: activateBrassBox,
                canAppear: true,
                appearsOnlyOnce: true,  // åªå‡ºç°ä¸€æ¬¡
                hasAppeared: false      // æ˜¯å¦å·²ç»å‡ºç°è¿‡
            },
            TICKET: {
                name: "æœºç¥¨",
                type: "å‰§æƒ…",
                description: "ä¸€å¼ ç¥ç§˜çš„æœºç¥¨å‡ºç°åœ¨ä½ é¢å‰",
                effect: "è¾“å…¥æ­£ç¡®å¯†ç æ‰èƒ½ç»§ç»­æ¸¸æˆ",
                effectFunc: activateTicket,
                canAppear: true
            },
            CAN_WINDMILL: {
                name: "æ˜“æ‹‰ç½é£è½¦",
                type: "å‰§æƒ…",
                description: "ä¸€é˜µé£å¹è¿‡ï¼Œæ˜“æ‹‰ç½é£è½¦å¼€å§‹è½¬åŠ¨",
                effect: "éšæœºæ¶ˆé™¤3å—å·²ç»å­˜åœ¨çš„æ–¹å—ï¼ˆæœ‰ä¸‹è½çš„ä¸‹è½ï¼‰",
                effectFunc: activateCanWindmill,
                canAppear: true
            }
        };

        // é“å…·å®šä¹‰
        const ITEMS = {
            QINGJUNCE: {
                name: "æ¸…å›ä¾§",
                description: "æ¸…é™¤æ¸¸æˆåŒºåŸŸå†…çš„æ‰€æœ‰æ–¹å—",
                effectFunc: clearAllBlocks
            },
            SODAWATER: {
                name: "è‹æ‰“æ°´",
                description: "éšæœºæ”¹å˜ä¸‹ä¸€ä¸ªæ–¹å—çš„å½¢çŠ¶",
                effectFunc: randomizeNextPiece
            }
        };

        // æ¸¸æˆå˜é‡
        let board = [];
        let currentPiece = null;
        let nextPiece = null;
        let score = 0;
        let gameOver = false;
        let isPaused = false;
        let gameStarted = false;
        let dropInterval = null;
        let dropSpeed = 1000;
        let originalDropSpeed = 1000;

        // å‰§æƒ…ç®¡ç†ç³»ç»Ÿå˜é‡
        let availableStories = []; // å½“å‰å¯ç”¨çš„å‰§æƒ…åˆ—è¡¨
        let usedStories = [];      // æœ¬è½®å·²ä½¿ç”¨çš„å‰§æƒ…
        let storyRound = 1;        // å½“å‰æ˜¯ç¬¬å‡ è½®
        let storyCount = 0;        // å·²è§¦å‘çš„å‰§æƒ…æ•°é‡ï¼ˆç”¨äºæ§åˆ¶é»„é“œç®±å­åœ¨ç¬¬3ä¸ªä»¥åå‡ºç°ï¼‰

        // ä¸Šä¸€ä¸ªæ–¹å—çŠ¶æ€ï¼ˆç”¨äºå²åŠªæ¯”æ’¤å›ï¼‰
        let previousBoard = null;
        let previousPiece = null;

        // é“å…·å’ŒçŠ¶æ€å˜é‡
        let items = {
            mojing: 0,      // å¢¨é•œ
            haitang: 0,     // æµ·æ£ 
            qingjunce: 0,   // æ¸…å›ä¾§
            sodawater: 0    // è‹æ‰“æ°´
        };

        // é“å…·æ¢å¤è®¡æ—¶å™¨
        let itemRecoveryTimers = {
            mojing: null,
            haitang: null,
            qingjunce: null,
            sodawater: null
        };

        // é“å…·æ¢å¤è¿›åº¦
        let itemRecoveryProgress = {
            mojing: 0,
            haitang: 0,
            qingjunce: 0,
            sodawater: 0
        };

        // çŠ¶æ€æ•ˆæœï¼ˆä¼šè¢«æ–°å‰§æƒ…è¦†ç›–ï¼‰
        let activeEffects = {
            nightFall: false,           // å¤œå¹•é™ä¸´
            immortal: false,            // é•¿ç”Ÿè€…
            bloodyWeather: false,       // æµè¡€çš„å¤©æ°”
            bloodyWeatherCount: 0,      // æµè¡€å¤©æ°”å‰©ä½™æ–¹å—æ•°
            friedLiver: false,          // ç‚’è‚ï¼ˆå†»ç»“æ“ä½œï¼‰
            friedLiverTimer: null,      // ç‚’è‚è®¡æ—¶å™¨
            yuanGhost: false            // å†¤é­‚æ•ˆæœï¼ˆé»‘è‰²æ–¹å—ï¼‰
        };

        // æ•ˆæœè®¡æ—¶å™¨ï¼ˆç”¨äºæ¸…é™¤æ•ˆæœï¼‰
        let effectTimers = {
            nightFall: null,
            immortal: null,
            friedLiver: null,
            yuanGhost: null
        };

        // DOMå…ƒç´ 
        const gameBoardElement = document.getElementById('game-board');
        const nextPieceBoardElement = document.getElementById('next-piece-board');
        const scoreElement = document.getElementById('score');
        const gameStatusElement = document.getElementById('game-status');
        const startRestartButton = document.getElementById('start-restart-button');
        const pauseResumeButton = document.getElementById('pause-resume-button');

        // é“å…·æ•°é‡æ˜¾ç¤ºå…ƒç´ å’Œé“å…·é¡¹
        const mojingCountElement = document.getElementById('mojing-count');
        const haitangCountElement = document.getElementById('haitang-count');
        const qingjunceCountElement = document.getElementById('qingjunce-count');
        const sodawaterCountElement = document.getElementById('sodawater-count');

        const mojingItemElement = document.getElementById('mojing-item');
        const haitangItemElement = document.getElementById('haitang-item');
        const qingjunceItemElement = document.getElementById('qingjunce-item');
        const sodawaterItemElement = document.getElementById('sodawater-item');

        // é“å…·æ¢å¤è¿›åº¦æ¡å…ƒç´ 
        const mojingRecoveryElement = document.getElementById('mojing-recovery');
        const haitangRecoveryElement = document.getElementById('haitang-recovery');
        const qingjunceRecoveryElement = document.getElementById('qingjunce-recovery');
        const sodawaterRecoveryElement = document.getElementById('sodawater-recovery');

        // äº‹ä»¶å¼¹çª—å…ƒç´ 
        const eventModal = document.getElementById('event-modal');
        const eventTitleElement = document.getElementById('event-title');
        const eventTypeElement = document.getElementById('event-type');
        const eventDescriptionElement = document.getElementById('event-description');
        const eventEffectDescElement = document.getElementById('event-effect-desc');
        const eventActionsElement = document.getElementById('event-actions');

        // é“å…·é€‰æ‹©å¼¹çª—å…ƒç´ 
        const itemSelectModal = document.getElementById('item-select-modal');
        const itemOptionsElement = document.getElementById('item-options');
        const cancelItemButton = document.getElementById('cancel-item-button');

        // è§¦æ‘¸æ§åˆ¶æŒ‰é’®
        const rotateBtn = document.getElementById('rotate-btn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const downBtn = document.getElementById('down-btn');
        const dropBtn = document.getElementById('drop-btn');

        // åˆå§‹åŒ–å‰§æƒ…ç³»ç»Ÿ
        function initStorySystem() {
            // é‡ç½®å‰§æƒ…ç³»ç»Ÿ
            availableStories = [];
            usedStories = [];
            storyRound = 1;
            storyCount = 0;

            // é‡ç½®æ‰€æœ‰å‰§æƒ…çš„å‡ºç°çŠ¶æ€ï¼ˆé™¤äº†é»„é“œç®±å­ï¼‰
            for (const key in STORIES) {
                if (key !== 'BRASS_BOX') {
                    STORIES[key].canAppear = true;
                } else {
                    STORIES[key].canAppear = false; // åˆå§‹ä¸å¯å‡ºç°
                    STORIES[key].hasAppeared = false;
                }
            }

            console.log(`å‰§æƒ…ç³»ç»Ÿåˆå§‹åŒ–ï¼Œç¬¬${storyRound}è½®`);
        }

        // è·å–ä¸‹ä¸€ä¸ªéšæœºå‰§æƒ…ï¼ˆä¿è¯ä¸é‡å¤ï¼‰
        function getNextRandomStory() {
            storyCount++;

            // å¦‚æœé»„é“œç®±å­è¿˜æ²¡å‡ºç°è¿‡ï¼Œå¹¶ä¸”å·²ç»è§¦å‘äº†3ä¸ªä»¥ä¸Šçš„å‰§æƒ…ï¼Œå¯ä»¥å‡ºç°é»„é“œç®±å­
            if (storyCount > 3 && !STORIES.BRASS_BOX.hasAppeared) {
                STORIES.BRASS_BOX.canAppear = true;
            }

            // æ„å»ºå¯ç”¨å‰§æƒ…åˆ—è¡¨
            availableStories = [];
            for (const key in STORIES) {
                if (STORIES[key].canAppear && !usedStories.includes(key)) {
                    // æ£€æŸ¥åªå‡ºç°ä¸€æ¬¡çš„å‰§æƒ…æ˜¯å¦å·²ç»å‡ºç°è¿‡
                    if (STORIES[key].appearsOnlyOnce && STORIES[key].hasAppeared) {
                        continue;
                    }
                    availableStories.push(key);
                }
            }

            // å¦‚æœå¯ç”¨å‰§æƒ…åˆ—è¡¨ä¸ºç©ºï¼Œé‡ç½®å¹¶è¿›å…¥ä¸‹ä¸€è½®
            if (availableStories.length === 0) {
                // é‡ç½®å·²ä½¿ç”¨åˆ—è¡¨
                usedStories = [];
                storyRound++;

                // é‡å»ºå¯ç”¨åˆ—è¡¨ï¼ˆæ’é™¤å·²ç»æ°¸ä¹…å‡ºç°è¿‡çš„ï¼‰
                for (const key in STORIES) {
                    if (STORIES[key].canAppear) {
                        // æ£€æŸ¥åªå‡ºç°ä¸€æ¬¡çš„å‰§æƒ…æ˜¯å¦å·²ç»å‡ºç°è¿‡
                        if (STORIES[key].appearsOnlyOnce && STORIES[key].hasAppeared) {
                            continue;
                        }
                        availableStories.push(key);
                    }
                }

                // æ‰“ä¹±é¡ºåºï¼ˆç¡®ä¿æ¯è½®é¡ºåºä¸åŒï¼‰
                shuffleArray(availableStories);

                console.log(`è¿›å…¥ç¬¬${storyRound}è½®å‰§æƒ…ï¼Œæ‰“ä¹±é¡ºåº`);
            }

            // ä»å¯ç”¨å‰§æƒ…ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            const randomIndex = Math.floor(Math.random() * availableStories.length);
            const storyKey = availableStories[randomIndex];

            // ä»å¯ç”¨åˆ—è¡¨ä¸­ç§»é™¤ï¼Œæ·»åŠ åˆ°å·²ä½¿ç”¨åˆ—è¡¨
            availableStories.splice(randomIndex, 1);
            usedStories.push(storyKey);

            // æ ‡è®°åªå‡ºç°ä¸€æ¬¡çš„å‰§æƒ…ä¸ºå·²å‡ºç°
            if (STORIES[storyKey].appearsOnlyOnce) {
                STORIES[storyKey].hasAppeared = true;
                STORIES[storyKey].canAppear = false;
            }

            console.log(`é€‰æ‹©å‰§æƒ…: ${STORIES[storyKey].name}ï¼Œå‰©ä½™å¯ç”¨: ${availableStories.length}ï¼Œæ€»è§¦å‘: ${storyCount}`);

            return STORIES[storyKey];
        }

        // æ‰“ä¹±æ•°ç»„é¡ºåº
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœï¼ˆè¢«æ–°å‰§æƒ…è¦†ç›–ï¼‰
        function clearAllEffects() {
            console.log("æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœ");

            // æ¸…é™¤å¤œå¹•é™ä¸´æ•ˆæœ
            if (activeEffects.nightFall) {
                gameBoardElement.classList.remove('night-fall');
                activeEffects.nightFall = false;
                if (effectTimers.nightFall) {
                    clearTimeout(effectTimers.nightFall);
                    effectTimers.nightFall = null;
                }
                // ç§»é™¤æç¤ºæ–‡å­—
                const warning = document.querySelector('.night-warning');
                if (warning && warning.parentNode) {
                    warning.remove();
                }
            }

            // æ¸…é™¤é•¿ç”Ÿè€…æ•ˆæœ
            if (activeEffects.immortal) {
                activeEffects.immortal = false;
                dropSpeed = originalDropSpeed;
                updateDropSpeed();
                if (effectTimers.immortal) {
                    clearTimeout(effectTimers.immortal);
                    effectTimers.immortal = null;
                }
            }

            // æ¸…é™¤ç‚’è‚æ•ˆæœ
            if (activeEffects.friedLiver) {
                activeEffects.friedLiver = false;
                if (effectTimers.friedLiver) {
                    clearTimeout(effectTimers.friedLiver);
                    effectTimers.friedLiver = null;
                }
                // ç§»é™¤å†»ç»“è¦†ç›–å±‚
                const freezeOverlay = document.querySelector('.freeze-overlay');
                if (freezeOverlay && freezeOverlay.parentNode) {
                    freezeOverlay.remove();
                }
            }

            // æ¸…é™¤æµè¡€å¤©æ°”æ•ˆæœ
            if (activeEffects.bloodyWeather) {
                activeEffects.bloodyWeather = false;
                activeEffects.bloodyWeatherCount = 0;
            }

            // æ¸…é™¤å†¤é­‚æ•ˆæœ
            if (activeEffects.yuanGhost) {
                activeEffects.yuanGhost = false;
                if (effectTimers.yuanGhost) {
                    clearTimeout(effectTimers.yuanGhost);
                    effectTimers.yuanGhost = null;
                }
            }

            // é‡æ–°ç»˜åˆ¶æ¸¸æˆæ¿
            drawBoard();
        }

        // åˆå§‹åŒ–æ¸¸æˆæ¿
        function createBoard() {
            board = Array.from({ length: BOARD_HEIGHT }, () =>
                Array.from({ length: BOARD_WIDTH }, () => EMPTY_CELL)
            );

            gameBoardElement.innerHTML = '';
            gameBoardElement.classList.remove('night-fall', 'blood-weather', 'yuan-ghost');

            for (let row = 0; row < BOARD_HEIGHT; row++) {
                for (let col = 0; col < BOARD_WIDTH; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    gameBoardElement.appendChild(cell);
                }
            }

            nextPieceBoardElement.innerHTML = '';
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    nextPieceBoardElement.appendChild(cell);
                }
            }

            updateItemDisplays();
        }

        // è·å–éšæœºæ–¹å—
        function getRandomPiece() {
            const tetrominoNames = Object.keys(TETROMINOES);
            const randomName = tetrominoNames[Math.floor(Math.random() * tetrominoNames.length)];
            return {
                name: randomName,
                shape: TETROMINOES[randomName].shape,
                className: TETROMINOES[randomName].className,
                row: 0,
                col: Math.floor(BOARD_WIDTH / 2) - Math.floor(TETROMINOES[randomName].shape[0].length / 2)
            };
        }

        // ä¿å­˜å½“å‰æ–¹å—çŠ¶æ€ï¼ˆç”¨äºå²åŠªæ¯”æ’¤å›ï¼‰
        function saveCurrentState() {
            // æ·±æ‹·è´å½“å‰æ¸¸æˆæ¿
            previousBoard = JSON.parse(JSON.stringify(board));
            // ä¿å­˜å½“å‰æ–¹å—
            previousPiece = currentPiece ? JSON.parse(JSON.stringify(currentPiece)) : null;
        }

        // ç»˜åˆ¶æ¸¸æˆæ¿
        function drawBoard() {
            const cells = document.querySelectorAll('#game-board .cell');

            cells.forEach(cell => {
                cell.className = 'cell';
                cell.textContent = '';
                cell.style.backgroundColor = '';
                cell.style.borderColor = '';
            });

            // åº”ç”¨æµè¡€å¤©æ°”æ•ˆæœ
            if (activeEffects.bloodyWeather) {
                gameBoardElement.classList.add('blood-weather');
            } else {
                gameBoardElement.classList.remove('blood-weather');
            }

            // åº”ç”¨å†¤é­‚æ•ˆæœï¼ˆé»‘è‰²æ–¹å—ï¼‰
            if (activeEffects.yuanGhost) {
                gameBoardElement.classList.add('yuan-ghost');
            } else {
                gameBoardElement.classList.remove('yuan-ghost');
            }

            // å¦‚æœå†¤é­‚å’Œæµè¡€å¤©æ°”åŒæ—¶å­˜åœ¨ï¼Œä¼˜å…ˆæ˜¾ç¤ºå†¤é­‚ï¼ˆé€šè¿‡CSSå¤„ç†ï¼‰

            for (let row = 0; row < BOARD_HEIGHT; row++) {
                for (let col = 0; col < BOARD_WIDTH; col++) {
                    if (board[row][col] !== EMPTY_CELL) {
                        const cellIndex = row * BOARD_WIDTH + col;
                        cells[cellIndex].classList.add('filled', board[row][col]);

                        // å¦‚æœå¤„äºå†¤é­‚çŠ¶æ€ï¼Œæ‰€æœ‰æ–¹å—æ˜¾ç¤ºä¸ºé»‘è‰²ï¼ˆä¼˜å…ˆäºæµè¡€å¤©æ°”ï¼‰
                        if (activeEffects.yuanGhost) {
                            cells[cellIndex].style.backgroundColor = '#000000';
                            cells[cellIndex].style.borderColor = '#444444';
                        }
                        // å¦‚æœå¤„äºæµè¡€å¤©æ°”çŠ¶æ€ï¼Œæ‰€æœ‰æ–¹å—æ˜¾ç¤ºä¸ºçº¢è‰²
                        else if (activeEffects.bloodyWeather) {
                            cells[cellIndex].style.backgroundColor = '#ff2a2a';
                            cells[cellIndex].style.borderColor = '#ff7a7a';
                        }
                    }
                }
            }

            if (currentPiece) {
                for (let row = 0; row < currentPiece.shape.length; row++) {
                    for (let col = 0; col < currentPiece.shape[row].length; col++) {
                        if (currentPiece.shape[row][col]) {
                            const boardRow = currentPiece.row + row;
                            const boardCol = currentPiece.col + col;

                            if (boardRow >= 0 && boardRow < BOARD_HEIGHT &&
                                boardCol >= 0 && boardCol < BOARD_WIDTH) {
                                const cellIndex = boardRow * BOARD_WIDTH + boardCol;

                                // å¦‚æœå¤„äºå†¤é­‚çŠ¶æ€ï¼Œå½“å‰æ–¹å—ä¹Ÿæ˜¾ç¤ºä¸ºé»‘è‰²ï¼ˆä¼˜å…ˆäºæµè¡€å¤©æ°”ï¼‰
                                if (activeEffects.yuanGhost) {
                                    cells[cellIndex].classList.add('filled');
                                    cells[cellIndex].style.backgroundColor = '#000000';
                                    cells[cellIndex].style.borderColor = '#444444';
                                }
                                // å¦‚æœå¤„äºæµè¡€å¤©æ°”çŠ¶æ€ï¼Œå½“å‰æ–¹å—ä¹Ÿæ˜¾ç¤ºä¸ºçº¢è‰²
                                else if (activeEffects.bloodyWeather) {
                                    cells[cellIndex].classList.add('filled');
                                    cells[cellIndex].style.backgroundColor = '#ff2a2a';
                                    cells[cellIndex].style.borderColor = '#ff7a7a';
                                } else {
                                    cells[cellIndex].classList.add('filled', currentPiece.className);
                                }
                            }
                        }
                    }
                }
            }
        }

        // ç»˜åˆ¶ä¸‹ä¸€ä¸ªæ–¹å—é¢„è§ˆ
        function drawNextPiece() {
            const cells = document.querySelectorAll('#next-piece-board .cell');

            cells.forEach(cell => {
                cell.className = 'cell';
                cell.textContent = '';
                cell.style.backgroundColor = '';
                cell.style.borderColor = '';
            });

            if (nextPiece) {
                const offsetX = Math.floor((4 - nextPiece.shape[0].length) / 2);
                const offsetY = Math.floor((4 - nextPiece.shape.length) / 2);

                for (let row = 0; row < nextPiece.shape.length; row++) {
                    for (let col = 0; col < nextPiece.shape[row].length; col++) {
                        if (nextPiece.shape[row][col]) {
                            const previewRow = row + offsetY;
                            const previewCol = col + offsetX;
                            const cellIndex = previewRow * 4 + previewCol;

                            if (cellIndex >= 0 && cellIndex < cells.length) {
                                // å¦‚æœå¤„äºæµè¡€å¤©æ°”çŠ¶æ€ï¼Œé¢„è§ˆæ–¹å—ä¹Ÿæ˜¾ç¤ºä¸ºçº¢è‰²
                                if (activeEffects.bloodyWeather && activeEffects.bloodyWeatherCount > 0) {
                                    cells[cellIndex].classList.add('filled');
                                    cells[cellIndex].style.backgroundColor = '#ff2a2a';
                                    cells[cellIndex].style.borderColor = '#ff7a7a';
                                } else {
                                    cells[cellIndex].classList.add('filled', nextPiece.className);
                                }
                            }
                        }
                    }
                }
            }
        }

        // æ›´æ–°é“å…·æ˜¾ç¤ºå’ŒçŠ¶æ€
        function updateItemDisplays() {
            mojingCountElement.textContent = items.mojing;
            haitangCountElement.textContent = items.haitang;
            qingjunceCountElement.textContent = items.qingjunce;
            sodawaterCountElement.textContent = items.sodawater;

            // æ›´æ–°æ¢å¤è¿›åº¦æ¡
            updateRecoveryBars();

            // æ›´æ–°é“å…·é¡¹çŠ¶æ€ï¼ˆæ˜¯å¦å¯ç”¨ï¼‰
            updateItemStates();
        }

        // æ›´æ–°æ¢å¤è¿›åº¦æ¡
        function updateRecoveryBars() {
            mojingRecoveryElement.style.width = `${itemRecoveryProgress.mojing}%`;
            haitangRecoveryElement.style.width = `${itemRecoveryProgress.haitang}%`;
            qingjunceRecoveryElement.style.width = `${itemRecoveryProgress.qingjunce}%`;
            sodawaterRecoveryElement.style.width = `${itemRecoveryProgress.sodawater}%`;
        }

        // æ›´æ–°é“å…·é¡¹çŠ¶æ€ï¼ˆæ˜¯å¦å¯ç”¨ï¼‰
        function updateItemStates() {
            // æ¸…å›ä¾§
            if (items.qingjunce > 0) {
                qingjunceItemElement.classList.remove('disabled');
            } else {
                qingjunceItemElement.classList.add('disabled');
            }

            // è‹æ‰“æ°´
            if (items.sodawater > 0) {
                sodawaterItemElement.classList.remove('disabled');
            } else {
                sodawaterItemElement.classList.add('disabled');
            }

            // æµ·æ£ 
            if (items.haitang > 0) {
                haitangItemElement.classList.remove('disabled');
            } else {
                haitangItemElement.classList.add('disabled');
            }

            // å¢¨é•œ
            if (items.mojing > 0) {
                mojingItemElement.classList.remove('disabled');
            } else {
                mojingItemElement.classList.add('disabled');
            }
        }

        // å¼€å§‹é“å…·æ¢å¤è®¡æ—¶å™¨
        function startItemRecovery(itemType) {
            // å¦‚æœå·²ç»æœ‰è®¡æ—¶å™¨åœ¨è¿è¡Œï¼Œå…ˆæ¸…é™¤
            if (itemRecoveryTimers[itemType]) {
                clearInterval(itemRecoveryTimers[itemType]);
            }

            // é‡ç½®æ¢å¤è¿›åº¦
            itemRecoveryProgress[itemType] = 0;

            // è®¡ç®—æ¢å¤é—´éš”ï¼ˆæ¯100æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
            const recoveryTime = ITEM_RECOVERY_TIMES[itemType];
            const interval = 100;
            const steps = recoveryTime / interval;
            const increment = 100 / steps;

            // å¼€å§‹æ¢å¤è®¡æ—¶å™¨
            itemRecoveryTimers[itemType] = setInterval(() => {
                itemRecoveryProgress[itemType] += increment;

                // æ›´æ–°è¿›åº¦æ¡
                updateRecoveryBars();

                // æ¢å¤å®Œæˆ
                if (itemRecoveryProgress[itemType] >= 100) {
                    clearInterval(itemRecoveryTimers[itemType]);
                    itemRecoveryTimers[itemType] = null;
                    itemRecoveryProgress[itemType] = 0;
                    items[itemType]++;
                    updateItemDisplays();

                    // æ˜¾ç¤ºè·å¾—æç¤º
                    let itemName = '';
                    if (itemType === 'mojing') itemName = 'å¢¨é•œ';
                    else if (itemType === 'haitang') itemName = 'æµ·æ£ ';
                    else if (itemType === 'qingjunce') itemName = 'æ¸…å›ä¾§';
                    else if (itemType === 'sodawater') itemName = 'è‹æ‰“æ°´';

                    showItemAddedMessage(itemName);
                }
            }, interval);
        }

        // ä½¿ç”¨é“å…·ï¼ˆä¼šè§¦å‘æ¢å¤è®¡æ—¶å™¨ï¼‰
        function useItem(itemType) {
            if (items[itemType] <= 0) {
                // é“å…·ä¸å¯ç”¨ï¼Œç»™ç”¨æˆ·åé¦ˆ
                const itemElement = document.getElementById(`${itemType}-item`);
                itemElement.style.animation = 'none';
                setTimeout(() => {
                    itemElement.style.animation = '';
                }, 10);
                return false;
            }

            items[itemType]--;
            updateItemDisplays();

            // å¼€å§‹æ¢å¤è®¡æ—¶å™¨
            startItemRecovery(itemType);

            return true;
        }

        // æ˜¾ç¤ºé“å…·è·å¾—æç¤º
        function showItemAddedMessage(itemName) {
            const message = document.createElement('div');
            message.className = 'item-added';
            message.textContent = `è·å¾—é“å…·ï¼š${itemName}`;
            document.body.appendChild(message);

            // 3ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 3000);
        }

        // æ£€æŸ¥ç¢°æ’
        function checkCollision(piece, rowOffset = 0, colOffset = 0) {
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        const newRow = piece.row + row + rowOffset;
                        const newCol = piece.col + col + colOffset;

                        if (
                            newRow >= BOARD_HEIGHT ||
                            newCol < 0 ||
                            newCol >= BOARD_WIDTH ||
                            (newRow >= 0 && board[newRow][newCol] !== EMPTY_CELL)
                        ) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        // ç§»åŠ¨æ–¹å—ï¼ˆè€ƒè™‘ç‚’è‚å†»ç»“æ•ˆæœï¼‰
        function movePiece(rowOffset, colOffset) {
            if (!currentPiece || gameOver || isPaused || !gameStarted) return false;

            // ç‚’è‚æ•ˆæœï¼šç©å®¶ä¸èƒ½æ“ä½œï¼Œä½†æ¸¸æˆæ­£å¸¸è¿›è¡Œ
            if (activeEffects.friedLiver) return false;

            if (!checkCollision(currentPiece, rowOffset, colOffset)) {
                currentPiece.row += rowOffset;
                currentPiece.col += colOffset;
                drawBoard();
                return true;
            }

            if (rowOffset > 0 && colOffset === 0) {
                lockPiece();
                return false;
            }

            return false;
        }

        // æ—‹è½¬æ–¹å—ï¼ˆè€ƒè™‘ç‚’è‚å†»ç»“æ•ˆæœï¼‰
        function rotatePiece() {
            if (!currentPiece || gameOver || isPaused || !gameStarted) return;

            // ç‚’è‚æ•ˆæœï¼šç©å®¶ä¸èƒ½æ“ä½œï¼Œä½†æ¸¸æˆæ­£å¸¸è¿›è¡Œ
            if (activeEffects.friedLiver) return;

            const originalShape = currentPiece.shape;
            const originalCol = currentPiece.col;
            const originalRow = currentPiece.row;

            const rotatedShape = [];
            const rows = originalShape.length;
            const cols = originalShape[0].length;

            for (let col = 0; col < cols; col++) {
                const newRow = [];
                for (let row = rows - 1; row >= 0; row--) {
                    newRow.push(originalShape[row][col]);
                }
                rotatedShape.push(newRow);
            }

            currentPiece.shape = rotatedShape;

            const kicks = [
                [0, 0],
                [0, -1],
                [0, 1],
                [-1, 0],
                [1, 0]
            ];

            let canRotate = false;

            for (const [rowOffset, colOffset] of kicks) {
                currentPiece.row = originalRow + rowOffset;
                currentPiece.col = originalCol + colOffset;

                if (!checkCollision(currentPiece)) {
                    canRotate = true;
                    break;
                }
            }

            if (!canRotate) {
                currentPiece.shape = originalShape;
                currentPiece.row = originalRow;
                currentPiece.col = originalCol;
            }

            drawBoard();
        }

        // ç›´æ¥è½ä¸‹æ–¹å—ï¼ˆè€ƒè™‘ç‚’è‚å†»ç»“æ•ˆæœï¼‰
        function dropPiece() {
            if (!currentPiece || gameOver || isPaused || !gameStarted) return;

            // ç‚’è‚æ•ˆæœï¼šç©å®¶ä¸èƒ½æ“ä½œï¼Œä½†æ¸¸æˆæ­£å¸¸è¿›è¡Œ
            if (activeEffects.friedLiver) return;

            while (movePiece(1, 0)) {
                // æŒç»­å‘ä¸‹ç§»åŠ¨ç›´åˆ°ç¢°æ’
            }
        }

        // å›ºå®šæ–¹å—åˆ°æ¸¸æˆæ¿
        function lockPiece() {
            if (!currentPiece) return;

            // åœ¨å›ºå®šæ–¹å—å‰ä¿å­˜çŠ¶æ€ï¼ˆç”¨äºå²åŠªæ¯”æ’¤å›ï¼‰
            saveCurrentState();

            for (let row = 0; row < currentPiece.shape.length; row++) {
                for (let col = 0; col < currentPiece.shape[row].length; col++) {
                    if (currentPiece.shape[row][col]) {
                        const boardRow = currentPiece.row + row;
                        const boardCol = currentPiece.col + col;

                        if (boardRow >= 0) {
                            // å¦‚æœå¤„äºæµè¡€å¤©æ°”çŠ¶æ€ï¼Œå›ºå®šä¸ºçº¢è‰²æ–¹å—
                            if (activeEffects.bloodyWeather && activeEffects.bloodyWeatherCount > 0) {
                                board[boardRow][boardCol] = 'z'; // ä½¿ç”¨zç±»ä½œä¸ºçº¢è‰²æ–¹å—æ ‡è¯†
                            } else {
                                board[boardRow][boardCol] = currentPiece.className;
                            }
                        }
                    }
                }
            }

            // å‡å°‘æµè¡€å¤©æ°”è®¡æ•°å™¨
            if (activeEffects.bloodyWeather && activeEffects.bloodyWeatherCount > 0) {
                activeEffects.bloodyWeatherCount--;
                if (activeEffects.bloodyWeatherCount <= 0) {
                    activeEffects.bloodyWeather = false;
                    gameStatusElement.textContent = "æµè¡€å¤©æ°”ç»“æŸ";
                    setTimeout(() => {
                        if (!gameOver && !isPaused && gameStarted) {
                            gameStatusElement.textContent = "æ¸¸æˆä¸­";
                        }
                    }, 2000);
                }
            }

            clearLines();

            // è·å–ä¸‹ä¸€ä¸ªæ–¹å—
            currentPiece = nextPiece;

            // å¦‚æœå¤„äºæµè¡€å¤©æ°”çŠ¶æ€ï¼Œç”Ÿæˆçº¢è‰²æ–¹å—
            if (activeEffects.bloodyWeather && activeEffects.bloodyWeatherCount > 0) {
                nextPiece = {
                    name: 'Z',
                    shape: TETROMINOES.Z.shape,
                    className: 'z', // çº¢è‰²æ–¹å—
                    row: 0,
                    col: Math.floor(BOARD_WIDTH / 2) - Math.floor(TETROMINOES.Z.shape[0].length / 2)
                };
            } else {
                nextPiece = getRandomPiece();
            }

            drawNextPiece();

            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (checkCollision(currentPiece)) {
                gameOver = true;
                gameStatusElement.textContent = "æ¸¸æˆç»“æŸ!";
                clearInterval(dropInterval);
                dropInterval = null;
                pauseResumeButton.disabled = true;
                pauseResumeButton.textContent = "æš‚åœ";
            }

            drawBoard();
        }

        // æ¸…é™¤å®Œæ•´çš„è¡Œ
        function clearLines() {
            let linesCleared = 0;

            for (let row = BOARD_HEIGHT - 1; row >= 0; row--) {
                if (board[row].every(cell => cell !== EMPTY_CELL)) {
                    board.splice(row, 1);
                    board.unshift(Array.from({ length: BOARD_WIDTH }, () => EMPTY_CELL));
                    linesCleared++;
                    row++;
                }
            }

            if (linesCleared > 0) {
                // æ›´æ–°åˆ†æ•°
                score += linesCleared * 100;
                scoreElement.textContent = score;

                gameStatusElement.textContent = `æ¶ˆé™¤äº† ${linesCleared} è¡Œ!`;

                // æ¯æ¬¡æ¶ˆé™¤éƒ½ä¼šè§¦å‘éšæœºå‰§æƒ…
                setTimeout(() => {
                    triggerRandomStory();
                }, 500);
            } else {
                if (!gameOver && !isPaused && gameStarted) {
                    gameStatusElement.textContent = "æ¸¸æˆä¸­";
                }
            }
        }

        // è§¦å‘éšæœºå‰§æƒ…
        function triggerRandomStory() {
            if (gameOver || isPaused) return;

            // æš‚åœæ¸¸æˆ
            clearInterval(dropInterval);
            isPaused = true;

            // è·å–ä¸‹ä¸€ä¸ªéšæœºå‰§æƒ…ï¼ˆä¿è¯ä¸é‡å¤ï¼‰
            const story = getNextRandomStory();

            // æ˜¾ç¤ºå‰§æƒ…å¼¹çª—
            showStoryModal(story);
        }

        // æ˜¾ç¤ºå‰§æƒ…å¼¹çª—
        function showStoryModal(story) {
            eventTitleElement.textContent = story.name;
            eventTypeElement.textContent = story.type;
            eventDescriptionElement.textContent = story.description;
            eventEffectDescElement.textContent = story.effect;

            // å¦‚æœæ˜¯é»„é“œç®±å­ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
            if (story.name === "é»„é“œç®±å­") {
                const eventContent = eventModal.querySelector('.event-content');
                eventContent.classList.add('brass-box-special');
            }

            // æ¸…ç©ºä¹‹å‰çš„åŠ¨ä½œæŒ‰é’®
            eventActionsElement.innerHTML = '';

            // æ ¹æ®å‰§æƒ…ç±»å‹æ·»åŠ ä¸åŒçš„åŠ¨ä½œæŒ‰é’®
            if (story.name === "é£Ÿå›ä¹‹ç¦„") {
                // é£Ÿå›ä¹‹ç¦„ï¼šéœ€è¦æ¶ˆè€—æµ·æ£ 
                const consumeButton = document.createElement('button');
                consumeButton.className = 'event-button consume';
                consumeButton.textContent = `æ¶ˆè€—1ä¸ªæµ·æ£ ç»§ç»­æ¸¸æˆ (å½“å‰:${items.haitang})`;
                consumeButton.onclick = () => {
                    if (items.haitang > 0) {
                        items.haitang--;
                        updateItemDisplays();
                        // å¼€å§‹æµ·æ£ æ¢å¤è®¡æ—¶å™¨
                        startItemRecovery('haitang');
                        // æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœ
                        clearAllEffects();
                        resumeGame();
                    } else {
                        // æ²¡æœ‰æµ·æ£ ï¼Œè§¦å‘å†¤é­‚æ•ˆæœ
                        handleYuanGhost();
                    }
                };

                const cancelButton = document.createElement('button');
                cancelButton.className = 'event-button cancel';
                cancelButton.textContent = 'æ‹’ç»æ¶ˆè€—æµ·æ£ ';
                cancelButton.onclick = () => {
                    // æ‹’ç»æ¶ˆè€—æµ·æ£ ï¼Œè§¦å‘å†¤é­‚æ•ˆæœ
                    handleYuanGhost();
                };

                eventActionsElement.appendChild(consumeButton);
                eventActionsElement.appendChild(cancelButton);

            } else if (story.name === "å¤œå¹•é™ä¸´") {
                // å¤œå¹•é™ä¸´ï¼šéœ€è¦æ¶ˆè€—å¢¨é•œ
                const consumeButton = document.createElement('button');
                consumeButton.className = 'event-button consume';
                consumeButton.textContent = `æ¶ˆè€—1ä¸ªå¢¨é•œç»§ç»­æ¸¸æˆ (å½“å‰:${items.mojing})`;
                consumeButton.onclick = () => {
                    if (items.mojing > 0) {
                        items.mojing--;
                        updateItemDisplays();
                        // å¼€å§‹å¢¨é•œæ¢å¤è®¡æ—¶å™¨
                        startItemRecovery('mojing');
                        // æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœ
                        clearAllEffects();
                        resumeGame();
                    } else {
                        // æ²¡æœ‰å¢¨é•œï¼Œè§¦å‘é»‘å¤œæ•ˆæœ
                        handleNightFallWithoutMojing();
                    }
                };

                const cancelButton = document.createElement('button');
                cancelButton.className = 'event-button cancel';
                cancelButton.textContent = 'æ‹’ç»æ¶ˆè€—å¢¨é•œ';
                cancelButton.onclick = () => {
                    // æ‹’ç»æ¶ˆè€—å¢¨é•œï¼Œè§¦å‘é»‘å¤œæ•ˆæœ
                    handleNightFallWithoutMojing();
                };

                eventActionsElement.appendChild(consumeButton);
                eventActionsElement.appendChild(cancelButton);

            } else if (story.name === "æœºç¥¨") {
                // æœºç¥¨ï¼šéœ€è¦è¾“å…¥æ­£ç¡®æ–‡æœ¬
                const inputContainer = document.createElement('div');
                inputContainer.className = 'input-container';

                const inputText = document.createElement('div');
                inputText.className = 'input-text';
                inputText.textContent = "å‘å¾®çš„â€”â€”";

                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.className = 'text-input';
                textInput.placeholder = 'è¯·è¾“å…¥...';

                const confirmButton = document.createElement('button');
                confirmButton.className = 'event-button';
                confirmButton.textContent = 'ç¡®è®¤';
                confirmButton.onclick = () => {
                    if (textInput.value === 'çˆ±æƒ…') {
                        // æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœ
                        clearAllEffects();
                        resumeGame();
                        // è§¦å‘å‰§æƒ…æ•ˆæœ
                        story.effectFunc();
                    } else {
                        alert('è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼');
                        textInput.value = '';
                        textInput.focus();
                    }
                };

                inputContainer.appendChild(inputText);
                inputContainer.appendChild(textInput);
                eventActionsElement.appendChild(inputContainer);
                eventActionsElement.appendChild(confirmButton);

                // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                setTimeout(() => {
                    textInput.focus();
                }, 100);

            } else {
                // å…¶ä»–å‰§æƒ…ï¼šç›´æ¥ç¡®è®¤ç»§ç»­
                const confirmButton = document.createElement('button');
                confirmButton.className = 'event-button';
                confirmButton.textContent = 'ç¡®è®¤ç»§ç»­';
                confirmButton.onclick = () => {
                    // æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœ
                    clearAllEffects();
                    resumeGame();
                    // è§¦å‘å‰§æƒ…æ•ˆæœ
                    story.effectFunc();
                };

                eventActionsElement.appendChild(confirmButton);
            }

            eventModal.classList.add('active');
        }

        // æ¢å¤æ¸¸æˆ
        function resumeGame() {
            eventModal.classList.remove('active');
            // ç§»é™¤é»„é“œç®±å­çš„ç‰¹æ®Šæ ·å¼
            const eventContent = eventModal.querySelector('.event-content');
            eventContent.classList.remove('brass-box-special');

            isPaused = false;
            if (!gameOver && gameStarted) {
                dropInterval = setInterval(() => {
                    movePiece(1, 0);
                }, dropSpeed);
                gameStatusElement.textContent = "æ¸¸æˆä¸­";
            }
        }

        // å¤„ç†é£Ÿå›ä¹‹ç¦„å‰§æƒ…
        function handleShijunzhilu() {
            // è¿™ä¸ªå‡½æ•°ä¸ä¼šè¢«ç›´æ¥è°ƒç”¨ï¼Œå› ä¸ºé£Ÿå›ä¹‹ç¦„æœ‰ç‰¹æ®Šçš„å¼¹çª—å¤„ç†
            console.log("é£Ÿå›ä¹‹ç¦„å‰§æƒ…å¤„ç†");
        }

        // å¤„ç†å†¤é­‚æ•ˆæœï¼ˆæ²¡æœ‰æµ·æ£ çš„æƒ…å†µï¼‰
        function handleYuanGhost() {
            // æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœ
            clearAllEffects();

            // è§¦å‘å†¤é­‚æ•ˆæœ
            activeEffects.yuanGhost = true;

            // æ˜¾ç¤ºå†¤å­—å¼¹çª—
            eventModal.classList.remove('active');

            // åˆ›å»ºå†¤å­—å¼¹çª—
            const yuanModal = document.createElement('div');
            yuanModal.className = 'event-modal active';
            yuanModal.innerHTML = `
                    <div class="event-content">
                        <div class="yuan-character">å†¤</div>
                        <div class="event-description">æ²¡æœ‰æµ·æ£ ä¾›å¥‰ï¼Œå†¤é­‚ç¼ ç»•ï¼æ‰€æœ‰æ–¹å—å˜ä¸ºé»‘è‰²...</div>
                        <button class="confirm-button" id="confirm-yuan-button">ç¡®è®¤</button>
                    </div>
                `;

            document.body.appendChild(yuanModal);

            // æ›´æ–°æ¸¸æˆæ¿æ˜¾ç¤ºï¼ˆé»‘è‰²æ–¹å—ä¼˜å…ˆï¼‰
            drawBoard();

            // è®¾ç½®å®šæ—¶å™¨ï¼Œ20ç§’åè‡ªåŠ¨æ¸…é™¤æ•ˆæœ
            effectTimers.yuanGhost = setTimeout(() => {
                activeEffects.yuanGhost = false;
                drawBoard();
                gameStatusElement.textContent = "å†¤é­‚æ•£å»";
                setTimeout(() => {
                    if (!gameOver && !isPaused && gameStarted) {
                        gameStatusElement.textContent = "æ¸¸æˆä¸­";
                    }
                }, 2000);
            }, 20000);

            // ç¡®è®¤æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-yuan-button').onclick = () => {
                yuanModal.remove();
                resumeGame();
            };
        }

        // å¤„ç†å¤œå¹•é™ä¸´å‰§æƒ…ï¼ˆæœ‰å¢¨é•œæ¶ˆè€—ï¼‰
        function handleNightFall() {
            // è¿™ä¸ªå‡½æ•°ä¸ä¼šè¢«ç›´æ¥è°ƒç”¨ï¼Œå› ä¸ºå¤œå¹•é™ä¸´æœ‰ç‰¹æ®Šçš„å¼¹çª—å¤„ç†
            console.log("å¤œå¹•é™ä¸´å‰§æƒ…å¤„ç†");
        }

        // å¤„ç†å¤œå¹•é™ä¸´ï¼ˆæ²¡æœ‰å¢¨é•œçš„æƒ…å†µï¼‰
        function handleNightFallWithoutMojing() {
            // æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•ˆæœ
            clearAllEffects();

            eventModal.classList.remove('active');

            // è§¦å‘å¤œå¹•é™ä¸´æ•ˆæœ
            activeEffects.nightFall = true;
            gameBoardElement.classList.add('night-fall');

            // æ·»åŠ æç¤ºæ–‡å­—
            const warning = document.createElement('div');
            warning.className = 'night-warning';
            warning.textContent = "å¤œå¹•é™ä¸´ï¼Œ5ç§’åæ¢å¤...";
            gameBoardElement.appendChild(warning);

            // æ¸¸æˆæ­£å¸¸è¿›è¡Œï¼Œåªæ˜¯ç©å®¶çœ‹ä¸åˆ°
            resumeGame();

            // 5ç§’åæ¢å¤
            effectTimers.nightFall = setTimeout(() => {
                activeEffects.nightFall = false;
                gameBoardElement.classList.remove('night-fall');
                if (warning.parentNode) {
                    warning.remove();
                }
                gameStatusElement.textContent = "å¤œå¹•æ•£å»";
                setTimeout(() => {
                    if (!gameOver && !isPaused && gameStarted) {
                        gameStatusElement.textContent = "æ¸¸æˆä¸­";
                    }
                }, 2000);
            }, 5000);
        }

        // é•¿ç”Ÿè€…æ•ˆæœ
        function activateImmortal() {
            activeEffects.immortal = true;
            originalDropSpeed = dropSpeed;
            dropSpeed *= 2; // é€Ÿåº¦å‡åŠ
            updateDropSpeed();
            gameStatusElement.textContent = "é•¿ç”Ÿè€…å‡ºç°ï¼æ–¹å—ä¸‹è½é€Ÿåº¦å˜æ…¢";

            // é•¿ç”Ÿè€…æ•ˆæœæŒç»­20ç§’
            effectTimers.immortal = setTimeout(() => {
                if (activeEffects.immortal) {
                    activeEffects.immortal = false;
                    dropSpeed = originalDropSpeed;
                    updateDropSpeed();
                    gameStatusElement.textContent = "é•¿ç”Ÿè€…æ•ˆæœç»“æŸ";
                    setTimeout(() => {
                        if (!gameOver && !isPaused && gameStarted) {
                            gameStatusElement.textContent = "æ¸¸æˆä¸­";
                        }
                    }, 2000);
                }
            }, 20000);
        }

        // ç‚’è‚æ•ˆæœ - ç©å®¶ä¸èƒ½æ“ä½œï¼Œä½†æ¸¸æˆæ­£å¸¸è¿›è¡Œ
        function activateFriedLiver() {
            // ç‚’è‚æ•ˆæœåœ¨ç¡®è®¤åè§¦å‘
            setTimeout(() => {
                if (activeEffects.friedLiver) return;

                activeEffects.friedLiver = true;
                gameStatusElement.textContent = "ç‚’è‚ç”Ÿæ•ˆï¼æ“ä½œè¢«å†»ç»“3ç§’";

                // åˆ›å»ºå†»ç»“æ•ˆæœè¦†ç›–å±‚
                const freezeOverlay = document.createElement('div');
                freezeOverlay.className = 'freeze-overlay';
                const freezeText = document.createElement('div');
                freezeText.className = 'freeze-text';
                freezeText.textContent = "åƒç‚’è‚ä¸­ï¼Œå‹¿æ‰°";
                freezeOverlay.appendChild(freezeText);
                gameBoardElement.appendChild(freezeOverlay);

                // 3ç§’åè§£é™¤å†»ç»“
                effectTimers.friedLiver = setTimeout(() => {
                    activeEffects.friedLiver = false;
                    if (freezeOverlay.parentNode) {
                        freezeOverlay.remove();
                    }
                    gameStatusElement.textContent = "ç‚’è‚æ•ˆæœç»“æŸ";
                    setTimeout(() => {
                        if (!gameOver && !isPaused && gameStarted) {
                            gameStatusElement.textContent = "æ¸¸æˆä¸­";
                        }
                    }, 2000);
                }, 3000);
            }, 100); // å»¶è¿Ÿä¸€ç‚¹ï¼Œç¡®ä¿æ¸¸æˆå·²ç»æ¢å¤
        }

        // æµè¡€å¤©æ°”æ•ˆæœ
        function activateBloodyWeather() {
            // å¦‚æœå·²ç»æœ‰å†¤é­‚æ•ˆæœï¼ˆé»‘è‰²æ–¹å—ï¼‰ï¼Œä¼˜å…ˆæ˜¾ç¤ºé»‘è‰²
            if (activeEffects.yuanGhost) {
                gameStatusElement.textContent = "æµè¡€å¤©æ°”è¢«å†¤é­‚æ•ˆæœè¦†ç›–";
                setTimeout(() => {
                    if (!gameOver && !isPaused && gameStarted) {
                        gameStatusElement.textContent = "æ¸¸æˆä¸­";
                    }
                }, 2000);
                return;
            }

            activeEffects.bloodyWeather = true;
            activeEffects.bloodyWeatherCount = 5; // æ¥ä¸‹æ¥çš„5ä¸ªæ–¹å—
            gameStatusElement.textContent = "æµè¡€çš„å¤©æ°”ï¼æ¥ä¸‹æ¥5ä¸ªæ–¹å—å˜ä¸ºçº¢è‰²";
            drawBoard();
            drawNextPiece();
        }

        // æˆæ›²æ•ˆæœ
        function activateOpera() {
            gameStatusElement.textContent = "æˆæ›²å“èµ·ï¼æ¸¸æˆæ°›å›´å˜åŒ–";
            setTimeout(() => {
                if (!gameOver && !isPaused && gameStarted) {
                    gameStatusElement.textContent = "æ¸¸æˆä¸­";
                }
            }, 3000);
        }

        // å²åŠªæ¯”æ•ˆæœ - æ’¤å›è¿™ä¸€æ­¥æ–¹å—
        function activateSnoopy() {
            if (previousBoard && previousPiece) {
                // æ¢å¤ä¹‹å‰çš„æ¸¸æˆæ¿çŠ¶æ€
                board = JSON.parse(JSON.stringify(previousBoard));
                currentPiece = JSON.parse(JSON.stringify(previousPiece));

                drawBoard();
                gameStatusElement.textContent = "å²åŠªæ¯”å¸®ä½ æ’¤å›äº†è¿™ä¸€æ­¥ï¼";
                setTimeout(() => {
                    if (!gameOver && !isPaused && gameStarted) {
                        gameStatusElement.textContent = "æ¸¸æˆä¸­";
                    }
                }, 2000);
            } else {
                gameStatusElement.textContent = "å²åŠªæ¯”å‡ºç°ï¼Œä½†æ²¡æœ‰å¯æ’¤å›çš„æ­¥éª¤";
                setTimeout(() => {
                    if (!gameOver && !isPaused && gameStarted) {
                        gameStatusElement.textContent = "æ¸¸æˆä¸­";
                    }
                }, 2000);
            }
        }

        // é»„é“œç®±å­æ•ˆæœ - åˆ†æ•°å˜æˆ9999
        function activateBrassBox() {
            score = 9999;
            scoreElement.textContent = score;
            gameStatusElement.textContent = "é»„é“œç®±å­ï¼åˆ†æ•°å˜ä¸º9999";
            setTimeout(() => {
                if (!gameOver && !isPaused && gameStarted) {
                    gameStatusElement.textContent = "æ¸¸æˆä¸­";
                }
            }, 2000);
        }

        // æœºç¥¨æ•ˆæœ - éœ€è¦è¾“å…¥æ­£ç¡®æ–‡æœ¬ï¼ˆå·²åœ¨showStoryModalä¸­å¤„ç†ï¼‰
        function activateTicket() {
            // æ•ˆæœåœ¨showStoryModalä¸­å¤„ç†ï¼Œè¿™é‡Œåªéœ€è®°å½•
            console.log("æœºç¥¨å‰§æƒ…æ¿€æ´»");
        }

        // æ˜“æ‹‰ç½é£è½¦æ•ˆæœ - éšæœºæ¶ˆé™¤3å—å·²ç»å­˜åœ¨çš„æ–¹å—
        function activateCanWindmill() {
            // æ”¶é›†æ‰€æœ‰å·²å¡«å……çš„æ–¹å—ä½ç½®
            const filledCells = [];
            for (let row = 0; row < BOARD_HEIGHT; row++) {
                for (let col = 0; col < BOARD_WIDTH; col++) {
                    if (board[row][col] !== EMPTY_CELL) {
                        filledCells.push({ row, col });
                    }
                }
            }

            if (filledCells.length === 0) {
                gameStatusElement.textContent = "æ˜“æ‹‰ç½é£è½¦è½¬åŠ¨ï¼Œä½†æ²¡æœ‰æ–¹å—å¯æ¶ˆé™¤";
                setTimeout(() => {
                    if (!gameOver && !isPaused && gameStarted) {
                        gameStatusElement.textContent = "æ¸¸æˆä¸­";
                    }
                }, 2000);
                return;
            }

            // éšæœºé€‰æ‹©3ä¸ªæ–¹å—ï¼ˆå¦‚æœæ€»æ•°ä¸è¶³3ä¸ªï¼Œåˆ™é€‰æ‹©æ‰€æœ‰ï¼‰
            const cellsToRemove = Math.min(3, filledCells.length);
            const removedPositions = [];

            for (let i = 0; i < cellsToRemove; i++) {
                const randomIndex = Math.floor(Math.random() * filledCells.length);
                const cell = filledCells[randomIndex];
                removedPositions.push({ ...cell });
                filledCells.splice(randomIndex, 1);

                // æ ‡è®°ä¸ºéœ€è¦ç§»é™¤
                board[cell.row][cell.col] = EMPTY_CELL;
            }

            // å¤„ç†æ–¹å—ä¸‹è½
            for (const pos of removedPositions) {
                // ä»è¢«ç§»é™¤çš„ä½ç½®å¼€å§‹ï¼Œä¸Šæ–¹çš„æ–¹å—ä¸‹è½
                for (let row = pos.row - 1; row >= 0; row--) {
                    if (board[row][pos.col] !== EMPTY_CELL) {
                        board[row + 1][pos.col] = board[row][pos.col];
                        board[row][pos.col] = EMPTY_CELL;
                    }
                }
            }

            drawBoard();
            gameStatusElement.textContent = `æ˜“æ‹‰ç½é£è½¦æ¶ˆé™¤äº†${cellsToRemove}ä¸ªæ–¹å—ï¼`;
            setTimeout(() => {
                if (!gameOver && !isPaused && gameStarted) {
                    gameStatusElement.textContent = "æ¸¸æˆä¸­";
                }
            }, 2000);
        }

        // é“å…·æ•ˆæœå‡½æ•°
        function clearAllBlocks() {
            // æ¸…é™¤æ‰€æœ‰æ–¹å—
            for (let row = 0; row < BOARD_HEIGHT; row++) {
                for (let col = 0; col < BOARD_WIDTH; col++) {
                    board[row][col] = EMPTY_CELL;
                }
            }
            drawBoard();
            gameStatusElement.textContent = "æ¸…å›ä¾§ï¼æ‰€æœ‰æ–¹å—å·²æ¸…é™¤";
            setTimeout(() => {
                if (!gameOver && !isPaused && gameStarted) {
                    gameStatusElement.textContent = "æ¸¸æˆä¸­";
                }
            }, 2000);
        }

        function randomizeNextPiece() {
            // éšæœºæ”¹å˜ä¸‹ä¸€ä¸ªæ–¹å—çš„å½¢çŠ¶
            nextPiece = getRandomPiece();
            drawNextPiece();
            gameStatusElement.textContent = "è‹æ‰“æ°´ç”Ÿæ•ˆï¼ä¸‹ä¸€ä¸ªæ–¹å—å·²æ”¹å˜";
            setTimeout(() => {
                if (!gameOver && !isPaused && gameStarted) {
                    gameStatusElement.textContent = "æ¸¸æˆä¸­";
                }
            }, 2000);
        }

        // æ›´æ–°ä¸‹è½é€Ÿåº¦
        function updateDropSpeed() {
            if (dropInterval) {
                clearInterval(dropInterval);
                dropInterval = setInterval(() => {
                    movePiece(1, 0);
                }, dropSpeed);
            }
        }

        // å¼€å§‹/é‡æ–°å¼€å§‹æ¸¸æˆ
        function startOrRestartGame() {
            if (gameStarted && !gameOver) {
                resetGame();
                startGame();
            } else {
                resetGame();
                startGame();
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            gameStarted = true;
            gameOver = false;
            isPaused = false;
            gameStatusElement.textContent = "æ¸¸æˆä¸­";
            startRestartButton.textContent = "é‡æ–°å¼€å§‹";
            pauseResumeButton.disabled = false;

            // åˆå§‹åŒ–å‰§æƒ…ç³»ç»Ÿ
            initStorySystem();

            // åˆå§‹åŒ–é“å…·ï¼ˆåˆå§‹å€¼ä¸º0ï¼Œä¼šè‡ªåŠ¨æ¢å¤ï¼‰
            items = {
                mojing: 0,
                haitang: 0,
                qingjunce: 0,
                sodawater: 0
            };

            // æ¸…é™¤æ‰€æœ‰æ¢å¤è®¡æ—¶å™¨
            for (const itemType in itemRecoveryTimers) {
                if (itemRecoveryTimers[itemType]) {
                    clearInterval(itemRecoveryTimers[itemType]);
                    itemRecoveryTimers[itemType] = null;
                }
                itemRecoveryProgress[itemType] = 0;
            }

            // å¼€å§‹æ‰€æœ‰é“å…·çš„æ¢å¤è®¡æ—¶å™¨
            startItemRecovery('mojing');
            startItemRecovery('haitang');
            startItemRecovery('qingjunce');
            startItemRecovery('sodawater');

            updateItemDisplays();

            // æ¸…é™¤æ‰€æœ‰æ•ˆæœ
            clearAllEffects();

            gameBoardElement.classList.remove('night-fall', 'blood-weather', 'yuan-ghost');

            // ç¡®ä¿æœ‰å½“å‰æ–¹å—å’Œä¸‹ä¸€ä¸ªæ–¹å—
            if (!currentPiece) {
                currentPiece = getRandomPiece();
            }

            if (!nextPiece) {
                nextPiece = getRandomPiece();
                drawNextPiece();
            }

            // é‡ç½®ä¸‹è½é€Ÿåº¦
            dropSpeed = 1000;
            originalDropSpeed = 1000;

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (dropInterval) {
                clearInterval(dropInterval);
            }

            // å¼€å§‹æ–°çš„å®šæ—¶å™¨
            dropInterval = setInterval(() => {
                movePiece(1, 0);
            }, dropSpeed);

            drawBoard();
        }

        // æš‚åœ/ç»§ç»­æ¸¸æˆ
        function togglePauseResume() {
            if (gameOver || !gameStarted) return;

            isPaused = !isPaused;

            if (isPaused) {
                clearInterval(dropInterval);
                gameStatusElement.textContent = "å·²æš‚åœ";
                pauseResumeButton.textContent = "ç»§ç»­";
            } else {
                gameStatusElement.textContent = "æ¸¸æˆä¸­";
                pauseResumeButton.textContent = "æš‚åœ";

                dropInterval = setInterval(() => {
                    movePiece(1, 0);
                }, dropSpeed);
            }
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGame() {
            // æ¸…é™¤å®šæ—¶å™¨
            if (dropInterval) {
                clearInterval(dropInterval);
                dropInterval = null;
            }

            // æ¸…é™¤é“å…·æ¢å¤è®¡æ—¶å™¨
            for (const itemType in itemRecoveryTimers) {
                if (itemRecoveryTimers[itemType]) {
                    clearInterval(itemRecoveryTimers[itemType]);
                    itemRecoveryTimers[itemType] = null;
                }
                itemRecoveryProgress[itemType] = 0;
            }

            // æ¸…é™¤æ•ˆæœè®¡æ—¶å™¨
            for (const timer in effectTimers) {
                if (effectTimers[timer]) {
                    clearTimeout(effectTimers[timer]);
                    effectTimers[timer] = null;
                }
            }

            // é‡ç½®æ¸¸æˆå˜é‡
            score = 0;
            gameOver = false;
            isPaused = false;
            gameStarted = false;
            dropSpeed = 1000;

            // æ¸…é™¤æ‰€æœ‰æ•ˆæœ
            clearAllEffects();

            // é‡ç½®å‰§æƒ…çŠ¶æ€
            previousBoard = null;
            previousPiece = null;

            // æ›´æ–°UI
            scoreElement.textContent = score;
            gameStatusElement.textContent = "å‡†å¤‡å¼€å§‹";
            startRestartButton.textContent = "å¼€å§‹æ¸¸æˆ";
            pauseResumeButton.textContent = "æš‚åœ";
            pauseResumeButton.disabled = true;

            // é‡ç½®æ¸¸æˆæ¿
            createBoard();
            currentPiece = getRandomPiece();
            nextPiece = getRandomPiece();
            drawNextPiece();
            drawBoard();
        }

        // é”®ç›˜æ§åˆ¶
        function handleKeyDown(event) {
            if (!gameStarted && event.key !== 'Enter') return;

            switch (event.key) {
                case 'ArrowLeft':
                    event.preventDefault();
                    movePiece(0, -1);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    movePiece(0, 1);
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    movePiece(1, 0);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    rotatePiece();
                    break;
                case ' ':
                    event.preventDefault();
                    dropPiece();
                    break;
                case 'p':
                case 'P':
                    event.preventDefault();
                    togglePauseResume();
                    break;
                case 'r':
                case 'R':
                    event.preventDefault();
                    resetGame();
                    startGame();
                    break;
                case 'Enter':
                    event.preventDefault();
                    startOrRestartGame();
                    break;
            }
        }

        // è®¾ç½®è§¦æ‘¸æ§åˆ¶å’Œé“å…·ç‚¹å‡»
        function setupTouchControls() {
            // æ—‹è½¬æŒ‰é’®
            rotateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                rotatePiece();
            });

            rotateBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                rotatePiece();
            });

            // ç§»åŠ¨æŒ‰é’®
            leftBtn.addEventListener('click', (e) => {
                e.preventDefault();
                movePiece(0, -1);
            });

            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                movePiece(0, -1);
            });

            rightBtn.addEventListener('click', (e) => {
                e.preventDefault();
                movePiece(0, 1);
            });

            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                movePiece(0, 1);
            });

            downBtn.addEventListener('click', (e) => {
                e.preventDefault();
                movePiece(1, 0);
            });

            downBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                movePiece(1, 0);
            });

            dropBtn.addEventListener('click', (e) => {
                e.preventDefault();
                dropPiece();
            });

            dropBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                dropPiece();
            });

            // é“å…·ç‚¹å‡»äº‹ä»¶
            qingjunceItemElement.addEventListener('click', () => {
                if (useItem('qingjunce')) {
                    ITEMS.QINGJUNCE.effectFunc();
                }
            });

            sodawaterItemElement.addEventListener('click', () => {
                if (useItem('sodawater')) {
                    ITEMS.SODAWATER.effectFunc();
                }
            });

            mojingItemElement.addEventListener('click', () => {
                // å¢¨é•œæ²¡æœ‰ç›´æ¥æ•ˆæœï¼Œåªæ˜¯ç”¨äºæŠµæ¶ˆå¤œå¹•é™ä¸´
            });

            haitangItemElement.addEventListener('click', () => {
                // æµ·æ£ æ²¡æœ‰ç›´æ¥æ•ˆæœï¼Œåªæ˜¯ç”¨äºæŠµæ¶ˆé£Ÿå›ä¹‹ç¦„
            });

            // å–æ¶ˆé“å…·é€‰æ‹©æŒ‰é’®
            cancelItemButton.addEventListener('click', () => {
                itemSelectModal.classList.remove('active');
            });

            // é˜²æ­¢è§¦æ‘¸æ»šåŠ¨
            document.querySelectorAll('.touch-btn').forEach(btn => {
                btn.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                });
            });

            // é“å…·é¡¹ä¹Ÿé˜²æ­¢è§¦æ‘¸æ»šåŠ¨
            document.querySelectorAll('.item').forEach(item => {
                item.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                });
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function init() {
            createBoard();
            resetGame();

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('keydown', handleKeyDown);
            startRestartButton.addEventListener('click', startOrRestartGame);
            pauseResumeButton.addEventListener('click', togglePauseResume);

            // è®¾ç½®è§¦æ‘¸æ§åˆ¶
            setupTouchControls();

            // åˆå§‹ç»˜åˆ¶
            drawBoard();
            drawNextPiece();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
